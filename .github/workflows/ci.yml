name: CI

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.22'
    
    - name: Run Go unit tests with race detector
      run: go test -v -race ./internal/...
    
    - name: Build binary
      run: make build
    
    - name: Run integration tests
      run: |
        ./openai-emulator &
        EMULATOR_PID=$!
        sleep 2
        EMULATOR_URL=http://localhost:8080 go test -v -race ./tests/...
        kill $EMULATOR_PID
    
    - name: Build Docker image
      run: docker build -t openai-emulator .

  conformance:
    runs-on: ubuntu-latest
    needs: test
    
    strategy:
      matrix:
        runtime: [nodejs, python]
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.22'
    
    - name: Set up Node.js
      if: matrix.runtime == 'nodejs'
      uses: actions/setup-node@v3
      with:
        node-version: '18'
    
    - name: Set up Python  
      if: matrix.runtime == 'python'
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Start emulator
      run: |
        make build
        ./openai-emulator &
        sleep 2
    
    - name: Run JavaScript tests
      if: matrix.runtime == 'nodejs'
      run: |
        cd conformance/js
        npm install
        npm test
    
    - name: Run Python tests
      if: matrix.runtime == 'python'
      run: |
        cd conformance/python
        pip install -r requirements.txt
        pytest -v

  docker:
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Build Docker image
      run: docker build -t openai-emulator .
    
    - name: Test Docker container
      run: |
        docker run -d -p 8080:8080 --name test-emulator openai-emulator
        sleep 2
        curl -f http://localhost:8080/healthz || (docker logs test-emulator && exit 1)
        curl -f http://localhost:8080/readyz || (docker logs test-emulator && exit 1)
        docker stop test-emulator